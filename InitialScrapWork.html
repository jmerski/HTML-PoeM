<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2D Side Scroller</title>
    <style>
        canvas { background: #eee; display: block; margin: 0 auto; }
        
        /* Sword Animation Styles */
        .sword-attack {
            position: absolute;
            width: 20px; /* Sword width */
            height: 50px; /* Sword height */
            transform-origin: bottom center; /* Sword rotates from the handle */
        }

        /* Right Swing Animation */
        @keyframes swing-right {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(120deg); }
        }

        /* Left Swing Animation */
        @keyframes swing-left {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-120deg); }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1600" height="800"></canvas>
    <img id="sword" src="art/croppedsword.png" class="sword-attack" style="display: none;" />

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Character object
        let character = {
            x: 50,
            y: 650, // Position character on the ground
            width: 80,
            height: 150,
            dx: 0,
            dy: 0,
            speed: 5,
            jumpPower: 12,
            isJumping: false,
            doubleJump: false,
            gravity: 0.5,
            facingRight: true,
            hitbox: { x: 50, y: 650, width: 80, height: 150 } // Character hitbox
        };

        // Training Dummy object
        let dummy = null; // No dummy at the start

        let keys = {};
        let characterImage = new Image();
        characterImage.src = "art/charnosword.png";

        characterImage.onload = function() {
            function drawCharacter() {
                ctx.save();
                if (!character.facingRight) {
                    ctx.scale(-1, 1);
                    ctx.drawImage(characterImage, -character.x - character.width, character.y, character.width, character.height);
                } else {
                    ctx.drawImage(characterImage, character.x, character.y, character.width, character.height);
                }
                ctx.restore();
            }

            function drawDummy() {
                if (dummy) {
                    ctx.drawImage(characterImage, dummy.x, dummy.y, dummy.width, dummy.height);
                    drawHealthBar();
                    drawDamageText();
                }
            }

            function drawHealthBar() {
                if (dummy) {
                    // Health bar background
                    ctx.fillStyle = 'red';
                    ctx.fillRect(dummy.x, dummy.y - 20, dummy.width, 10);

                    // Health bar foreground
                    ctx.fillStyle = 'green';
                    let healthWidth = (dummy.health / dummy.maxHealth) * dummy.width;
                    ctx.fillRect(dummy.x, dummy.y - 20, healthWidth, 10);
                }
            }

            function drawDamageText() {
                if (dummy && dummy.showDamage) {
                    ctx.fillStyle = 'yellow';
                    ctx.font = '20px Arial';
                    ctx.fillText(`-${dummy.damageTaken}`, dummy.x + dummy.width / 2, dummy.y - 30);
                }
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function update() {
                clearCanvas();
                moveCharacter();
                applyGravity();
                drawCharacter();
                drawDummy();
                updateHitboxes();
                drawHitbox(character.hitbox); // Optional: Draw character hitbox for visualization
                if (dummy) drawHitbox(dummy.hitbox); // Optional: Draw dummy hitbox for visualization
                updateDamageTimer(); // Update the damage display timer
                requestAnimationFrame(update);
            }

            function moveCharacter() {
                if (keys['ArrowLeft']) {
                    character.dx = -character.speed;
                    character.facingRight = false;
                }
                if (keys['ArrowRight']) {
                    character.dx = character.speed;
                    character.facingRight = true;
                }
                if (!keys['ArrowLeft'] && !keys['ArrowRight']) {
                    character.dx = 0;
                }
                character.x = Math.min(Math.max(character.x + character.dx, 0), canvas.width - character.width);

                if (keys['ArrowUp'] && !character.isJumping) {
                    character.dy = -character.jumpPower;
                    character.isJumping = true;
                } else if (keys['ArrowUp'] && character.isJumping && !character.doubleJump) {
                    character.dy = -character.jumpPower;
                    character.doubleJump = true;
                }

                // Sword Swing Logic
                if (keys['a'] && dummy) {
                    let swordHitbox = getSwordHitbox(); // Get the sword hitbox
                    drawHitbox(swordHitbox); // Optional: Draw sword hitbox for visualization

                    // Perform collision detection with dummy
                    if (checkCollision(swordHitbox, dummy.hitbox)) {
                        dummy.damageTaken = 10; // Set the damage amount
                        dummy.health -= dummy.damageTaken; // Decrease dummy health
                        dummy.health = Math.max(dummy.health, 0); // Prevent negative health
                        dummy.showDamage = true; // Show the damage text
                        dummy.damageTimer = 30; // Set timer for how long damage text is displayed

                        console.log("Dummy hit! Health:", dummy.health);
                        if (dummy.health <= 0) {
                            console.log("Dummy destroyed!");
                            dummy = null; // Despawn dummy
                            setTimeout(spawnDummy, 10000); // Respawn dummy after 10 seconds
                        }
                    }
                }
            }

            function applyGravity() {
                character.dy += character.gravity;
                character.y += character.dy;
                if (character.y + character.height > canvas.height) {
                    character.y = canvas.height - character.height;
                    character.dy = 0;
                    character.isJumping = false;
                    character.doubleJump = false;
                }
            }

            function updateHitboxes() {
                // Update character hitbox position
                character.hitbox.x = character.x;
                character.hitbox.y = character.y;

                // Update dummy hitbox position if dummy exists
                if (dummy) {
                    dummy.hitbox.x = dummy.x;
                    dummy.hitbox.y = dummy.y;
                }
            }

            function getSwordHitbox() {
                let swordWidth = 50;
                let swordHeight = 20;
                let swordX = character.facingRight ? character.x + character.width : character.x - swordWidth;
                let swordY = character.y + character.height / 2;

                return {
                    x: swordX,
                    y: swordY,
                    width: swordWidth,
                    height: swordHeight
                };
            }

            function checkCollision(rect1, rect2) {
                return (
                    rect1.x < rect2.x + rect2.width &&
                    rect1.x + rect1.width > rect2.x &&
                    rect1.y < rect2.y + rect2.height &&
                    rect1.y + rect1.height > rect2.y
                );
            }

            function drawHitbox(hitbox) {
                ctx.strokeStyle = 'red';
                ctx.strokeRect(hitbox.x, hitbox.y, hitbox.width, hitbox.height);
            }

            function updateDamageTimer() {
                if (dummy && dummy.showDamage) {
                    dummy.damageTimer--;
                    if (dummy.damageTimer <= 0) {
                        dummy.showDamage = false;
                    }
                }
            }

            function spawnDummy() {
                dummy = {
                    x: 400,
                    y: 650, // Position dummy on the ground
                    width: 80,
                    height: 150,
                    maxHealth: 100,
                    health: 100,
                    hitbox: { x: 400, y: 650, width: 80, height: 150 }, // Dummy hitbox
                    damageTaken: 0, // Damage taken for visual effect
                    showDamage: false, // Whether to show the damage text
                    damageTimer: 0 // Timer for damage text visibility
                };
                console.log("Dummy spawned!");
            }

            document.addEventListener('keydown', function(event) {
                keys[event.key] = true;
            });

            document.addEventListener('keyup', function(event) {
                keys[event.key] = false;
            });

            // Initial dummy spawn
            spawnDummy();
            update();
        };
    </script>
</body>
</html>
